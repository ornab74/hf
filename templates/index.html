<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HeartFlow Web Console</title>
  <link rel="stylesheet" href="{{ bootstrap_css.href }}" integrity="{{ bootstrap_css.integrity }}" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/orbitron@5.0.18/700.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<main class="hf-shell">
  <section class="glass-card" {% if result %}style="--hf-glass: {{ result.glass }};"{% endif %}>
    <h1 class="title">HeartFlow Trainer Console</h1>
    <p class="subtitle">Advanced HF scoring, simulation-driven coaching, and quantum-RAG grounded planning.</p>

    <form method="post" action="{{ url_for('analyze') }}" class="hf-form mb-2">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
      <div class="input-wrap">
        <span class="at">@</span>
        <input name="handle" id="handle" placeholder="username" maxlength="15" required>
      </div>
      <div class="trainer-btn-wrap">
        <button class="btn btn-primary trainer-btn" id="train-btn" type="submit">
          <span class="btn-label">‚ö° Train HeartFlow Profile</span>
          <span class="spinner-border spinner-border-sm btn-spinner" role="status" aria-hidden="true"></span>
        </button>
      </div>
    </form>

    <div class="mini-actions">
      <form method="post" action="{{ url_for('refresh_trends_route') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
        <button class="btn btn-outline-light btn-sm" type="submit">Refresh Trends</button>
      </form>
      <form method="post" action="{{ url_for('score_trends_route') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
        <button class="btn btn-outline-info btn-sm" type="submit">Score Trends</button>
      </form>
      <form method="post" action="{{ url_for('clear_nodes_route') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
        <button class="btn btn-outline-warning btn-sm" type="submit">Clear Nodes</button>
      </form>
    </div>

    <form method="post" action="{{ url_for('score_batch_route') }}" class="mt-2">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
      <textarea class="form-control" rows="2" name="batch_input" placeholder="Batch: alice,bob OR @foo:dao OR trend_name:trend"></textarea>
      <button class="btn btn-secondary btn-sm mt-2" type="submit">Score Batch</button>
    </form>

    <div class="status mt-3">Status: {{ status }}</div>
    {% if error %}<div class="alert alert-danger mt-2" role="alert">{{ error }}</div>{% endif %}
    <div id="loading-indicator" class="loading-indicator" aria-live="polite" hidden>
      <div class="spinner-border text-info" role="status" aria-hidden="true"></div>
      <span>Running deep HF simulation + quantum RAG pass‚Ä¶</span>
    </div>

    <ul class="nav nav-tabs mt-3" role="tablist">
      {% set tabs = ['overview','posts','trends','nodes','matrix','heatmap','clusters','drift','log'] %}
      {% for t in tabs %}
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == t %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#tab-{{ t }}" type="button">{{ t|capitalize }}</button>
      </li>
      {% endfor %}
    </ul>

    <div class="tab-content pt-3">
      <section id="tab-overview" class="tab-pane fade {% if active_tab == 'overview' %}show active{% endif %}">
        {% if result %}
        <div class="result">
          <div class="headline">
            <h2>@{{ result.handle }}</h2>
            <span class="badge text-bg-light">{{ result.vibe }}</span>
          </div>
          <p class="meta">HF: <strong>{{ result.score }}</strong> ¬∑ Overall: {{ result.overall }}% ¬∑ Confidence: {{ result.confidence }} ¬∑ Risk: {{ result.risk_score }} ¬∑ Sig: {{ result.signature }}</p>
          <p class="small text-warning">Flags: {{ result.flags|join(', ') or 'none' }}</p>
          <p>{{ result.reasoning }}</p>
          {% if result.simulated_inner_text %}<div class="sim-box mt-2"><h3>Simulated Inner Narrative</h3><p>{{ result.simulated_inner_text }}</p></div>{% endif %}
          {% if result.counterfactuals %}<p class="small text-light mb-1"><strong>Counterfactuals</strong></p><ul>{% for c in result.counterfactuals %}<li>{{ c }}</li>{% endfor %}</ul>{% endif %}
          {% if result.calibration_notes %}<p class="small text-info mb-1"><strong>Calibration Notes</strong></p><ul>{% for c in result.calibration_notes %}<li>{{ c }}</li>{% endfor %}</ul>{% endif %}
          <div class="grid">
            {% for key, value in result.axes.items() %}
            <div class="axis">
              <div class="axis-head"><span>{{ key }}</span><span>{{ (value * 100)|round(1) }}%</span></div>
              <div class="bar"><div class="bar-fill" style="width: {{ (value * 100)|round(1) }}%"></div></div>
            </div>
            {% endfor %}
          </div>

          <div class="quantum-box mt-3">
            <h3>Quantum Metrics</h3>
            <p>Coherence: <strong>{{ result.quantum.coherence }}</strong> ¬∑ Entropy bits: <strong>{{ result.quantum.entropy_bits }}</strong> ¬∑ Entanglement bits: <strong>{{ result.quantum.entanglement_bits }}</strong></p>
            <p>ent_bits: <strong>{{ result.quantum.ent_bits }}</strong> ¬∑ mutual_bits: <strong>{{ result.quantum.mutual_bits }}</strong> ¬∑ kicks_used: {{ result.quantum.kicks_used }}</p>
            <p class="small">Dominant: {% for mode in result.quantum.dominant_modes %}<span class="mode-pill">{{ mode.axis }} {{ (mode.weight * 100)|round(1) }}%</span>{% endfor %}</p>
            <p class="small">Trajectory: {{ result.quantum.trajectory }}</p>
          </div>


          {% if result.quantum_rag_surface and result.quantum_rag_surface.top_surface %}
          <div class="quantum-box mt-3">
            <h3>Quantum RAG Surface (Tweet Evidence)</h3>
            <div class="rag-grid">
              {% for ev in result.quantum_rag_surface.top_surface %}
              <div class="rag-card">
                <div class="small text-info">axis={{ ev.axis }} ¬∑ weight={{ ev.weight }}</div>
                <div>{{ ev.text }}</div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          {% if result.llm %}
          <div class="quantum-box mt-3">
            <h3>LLM Results (sanitized)</h3>
            <p class="long-copy">{{ result.llm.vibe_summary }}</p>
            {% if result.llm.strengths %}<p class="small text-success mb-1"><strong>Strengths</strong></p><ul>{% for s in result.llm.strengths %}<li>{{ s }}</li>{% endfor %}</ul>{% endif %}
            {% if result.llm.risks %}<p class="small text-warning mb-1"><strong>Risks</strong></p><ul>{% for r in result.llm.risks %}<li>{{ r }}</li>{% endfor %}</ul>{% endif %}
            {% if result.llm.advice %}<p class="small text-info mb-1"><strong>Advice</strong></p><ul>{% for a in result.llm.advice %}<li>{{ a }}</li>{% endfor %}</ul>{% endif %}
            {% if result.llm.next_7_days %}<p class="small text-light mb-1"><strong>Next 7 Days</strong></p><ul>{% for d in result.llm.next_7_days %}<li>{{ d }}</li>{% endfor %}</ul>{% endif %}
          </div>


          {% if result.llm.suggestion_tracks %}
          <div class="quantum-box mt-3">
            <h3>Suggestion Tracks (Quantum-RAG Grounded)</h3>
            <div class="tracks-grid">
              {% for tr in result.llm.suggestion_tracks %}
              <article class="track-card">
                <h5>{{ tr.name }}</h5>
                <p class="small text-info">Axis: {{ tr.evidence_axis }} ¬∑ Confidence: {{ (tr.confidence * 100)|round(1) }}%</p>
                <p>{{ tr.why_now }}</p>
                <ul>{% for a in tr.actions %}<li>{{ a }}</li>{% endfor %}</ul>
              </article>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          {% if result.llm.deep_dive_plan %}
          <div class="quantum-box mt-3">
            <h3>Deep Dive Plan</h3>
            <div class="tracks-grid">
              {% for d in result.llm.deep_dive_plan %}
              <article class="track-card">
                <h5>{{ d.phase }}</h5>
                <p>{{ d.goal }}</p>
                <ul>{% for t in d.tasks %}<li>{{ t }}</li>{% endfor %}</ul>
                <p class="small text-info">Success metric: {{ d.metric }}</p>
              </article>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          {% if result.llm.future_simulations %}
          <div class="quantum-box mt-3">
            <h3>Future Simulations</h3>
            <div class="tracks-grid">
              {% for fs in result.llm.future_simulations %}
              <article class="track-card">
                <h5>{{ fs.horizon }}</h5>
                <p>{{ fs.scenario }}</p>
                <p class="small text-success"><strong>Upside:</strong> {{ fs.upside }}</p>
                <p class="small text-warning"><strong>Risk:</strong> {{ fs.risk }}</p>
                <p class="small text-info"><strong>Steering move:</strong> {{ fs.steering_move }}</p>
              </article>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          {% if result.llm.three_new_ideas %}
          <div class="quantum-box mt-3">
            <h3>3 New Ideas</h3>
            <div class="tracks-grid">
              {% for i in result.llm.three_new_ideas %}
              <article class="track-card">
                <h5>{{ i.title }}</h5>
                <p>{{ i.why }}</p>
                <p class="small"><strong>First step:</strong> {{ i.first_step }}</p>
              </article>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          {% if result.llm.outlooks %}
          <div class="outlook-grid mt-3">
            {% for step in result.llm.outlooks %}
            <article class="outlook">
              <h4>{{ step.horizon }} ¬∑ {{ step.title }}</h4>
              <p>{{ step.focus }}</p>
              <ul>{% for action in step.actions %}<li>{{ action }}</li>{% endfor %}</ul>
              <p class="milestone">Milestone: {{ step.milestone }}</p>
            </article>
            {% endfor %}
          </div>
          {% endif %}

          {% if result.llm.human_trips %}
          <div class="trips mt-3">
            <h3>LLM Human Trips</h3>
            {% for trip in result.llm.human_trips %}
            <div class="trip-card">
              <h5>{{ trip.name }}</h5>
              <p><strong>Why:</strong> {{ trip.why }}</p>
              <p><strong>Challenge:</strong> {{ trip.challenge }}</p>
            </div>
            {% endfor %}
          </div>
          {% endif %}
          {% endif %}
        </div>
        {% else %}
          <p>No analysis yet.</p>
        {% endif %}
      </section>

      <section id="tab-posts" class="tab-pane fade {% if active_tab == 'posts' %}show active{% endif %}">
        {% if posts %}
          {% for p in posts %}
          <div class="item-card">
            <div class="small text-info">{{ p.created_at }} ¬∑ ‚ù§Ô∏è{{ p.likes }} ¬∑ üîÅ{{ p.rts }}</div>
            <div>{{ p.text }}</div>
          </div>
          {% endfor %}
        {% else %}
          <p>No posts loaded.</p>
        {% endif %}
      </section>

      <section id="tab-trends" class="tab-pane fade {% if active_tab == 'trends' %}show active{% endif %}">
        {% if trends %}
          {% for t in trends %}<div class="item-card"><strong>{{ t.name }}</strong> ¬∑ volume {{ t.volume }}</div>{% endfor %}
        {% else %}
          <p>No trends loaded yet.</p>
        {% endif %}
      </section>

      <section id="tab-nodes" class="tab-pane fade {% if active_tab == 'nodes' %}show active{% endif %}">
        {% if panels.node_rows %}
          {% for n in panels.node_rows %}
          <div class="item-card">
            <div><strong>@{{ n.name }}</strong> ¬∑ {{ n.node_type }} ¬∑ HF={{ n.score }} ¬∑ conf={{ n.confidence }} ¬∑ risk={{ n.risk }} ¬∑ ent={{ n.ent }}b ¬∑ I={{ n.mutual }}b</div>
            <div class="small">{{ n.axes }}</div>
            <div class="small">drift: {{ n.drift }} ¬∑ flags: {{ n.flags }}</div>
            {% if n.reasoning %}<div class="small">note: {{ n.reasoning }}</div>{% endif %}
          </div>
          {% endfor %}
        {% else %}
          <p>No nodes yet.</p>
        {% endif %}
      </section>

      <section id="tab-matrix" class="tab-pane fade {% if active_tab == 'matrix' %}show active{% endif %}"><pre>{{ panels.matrix }}</pre></section>
      <section id="tab-heatmap" class="tab-pane fade {% if active_tab == 'heatmap' %}show active{% endif %}"><pre>{{ panels.heatmap }}</pre></section>
      <section id="tab-clusters" class="tab-pane fade {% if active_tab == 'clusters' %}show active{% endif %}"><pre>{{ panels.clusters }}</pre></section>
      <section id="tab-drift" class="tab-pane fade {% if active_tab == 'drift' %}show active{% endif %}"><pre>{{ panels.drift }}</pre></section>
      <section id="tab-log" class="tab-pane fade {% if active_tab == 'log' %}show active{% endif %}"><pre>{{ panels.logs }}</pre></section>
    </div>
  </section>
</main>
<script src="{{ bootstrap_js.src }}" integrity="{{ bootstrap_js.integrity }}" crossorigin="anonymous"></script>
<script>
  document.querySelectorAll("form[action$='/analyze']").forEach((form)=>{
    form.addEventListener("submit", ()=>{
      const el=document.getElementById("loading-indicator");
      const btn=document.getElementById("train-btn");
      if(el){ el.hidden=false; }
      if(btn){
        btn.classList.add("is-loading");
        btn.setAttribute("disabled","disabled");
      }
    });
  });
</script>
</body>
</html>
